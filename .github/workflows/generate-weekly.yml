name: Generate Weekly Devotions (Fri–Thu)

on:
  schedule:
    # Fridays 03:05 ET ~ 08:05 UTC during standard time
    - cron: '5 8 * * 5'
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD). Blank = script default"
        required: false
        default: ""
      days:
        description: "How many days (default 8)"
        required: false
        default: "8"

concurrency:
  group: generate-weekly
  cancel-in-progress: true

jobs:
  gen-weekly:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_PROJECT: ${{ secrets.OPENAI_PROJECT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      APP_TZ: "America/New_York"
      GEN_MODEL: "gpt-5-mini"
      GEN_FALLBACK: "gpt-5-mini"
      GEN_TEMP: "1"
      GEN_TEMP_REPAIR: "1"
      GEN_TEMP_QUOTE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 jsonschema openai
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Syntax check generate_weekly.py
        shell: bash
        run: |
          python - <<'PY'
          import ast, pathlib
          p = pathlib.Path('scripts/generate_weekly.py')
          ast.parse(p.read_text(encoding='utf-8'))
          print("Syntax OK:", p)
          PY

      - name: Show existing weeklyfeed.json (if present)
        run: |
          if [ -f public/weeklyfeed.json ]; then
            echo "SHA: $GITHUB_SHA"
            head -n 60 public/weeklyfeed.json
          else
            echo "No existing public/weeklyfeed.json (first run?)"
          fi

      - name: USCCB precheck (no OpenAI calls)
        timeout-minutes: 2
        continue-on-error: true
        env:
          USCCB_PRECHECK: "1"
          START_DATE: ${{ github.event.inputs.start_date }}
          DAYS: ${{ github.event.inputs.days }}
        run: |
          set +e
          python scripts/generate_weekly.py || true
          echo "::warning::USCCB precheck may time out (network/markup changes). Continuing."

      - name: Generate weeklyfeed.json
        env:
          TZ: America/New_York
          START_DATE: ${{ github.event.inputs.start_date }}
          DAYS: ${{ github.event.inputs.days }}
          USCCB_STRICT: "0"
          USE_EWTN_FALLBACK: "1"
          USE_CATHOLIC_GALLERY: "1"   # <— new
        run: |
          set -euo pipefail
          python scripts/generate_weekly.py

      - name: Generate weeklyfeed.json
        env:
          TZ: America/New_York
          START_DATE: ${{ github.event.inputs.start_date }}
          DAYS: ${{ github.event.inputs.days }}
          USCCB_STRICT: "0"
          USE_EWTN_FALLBACK: "1"
        run: |
          set -euo pipefail
          python scripts/generate_weekly.py

      - name: Sanity checks (psalm/second/saint)
        shell: bash
        run: |
          python - << 'PY'
          import json, re, sys
      
          d = json.load(open('public/weeklyfeed.json','r', encoding='utf-8'))
      
          # Accept ANY scripture ref like:
          # "Psalm 50:1-3", "Daniel 3:52-56", "1 Chronicles 29:10-12", etc.
          ref_re = re.compile(
              r'\b(?:[1-3]\s*)?[A-Za-z][A-Za-z ]*\s+\d+'
              r'(?::\d+[a-z]*?(?:-\d+)?(?:,\s*\d+[a-z]*?(?:-\d+)?)*)?',
              re.I,
          )
      
          errs = []
          for row in d:
              iso = row.get('date','?')
      
              # --- psalmRef sanity ---
              ps = (row.get('psalmRef','') or '').strip()
              if not ps or not ref_re.search(ps):
                  errs.append(f"{iso}: psalmRef looks wrong -> {ps!r}")
      
              # --- second reading sanity ---
              sr = (row.get('secondReadingRef','') or '').strip()
              sr_txt = (row.get('secondReading','') or '').strip()
      
              if not sr and sr_txt:
                  errs.append(f"{iso}: secondReading present but secondReadingRef is empty")
      
              if sr and len(sr_txt.split()) < 50:
                  errs.append(f"{iso}: secondReading too short (<50 words) with ref {sr!r}")
      
              # --- saint / feast soft check ---
              if not (row.get('saintReflection','').strip() or row.get('feast','').strip()):
                  print(f"[warn] {iso}: saint/feast is blank – ok for simple weekdays.")
      
          if errs:
              print("Sanity check errors:")
              print("\n- ".join("• " + e for e in errs))
              sys.exit(1)
      
          print("Sanity checks ✅ passed.")
          PY

      - name: Debug invalid rows (types/keys)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          d = json.load(open('public/weeklyfeed.json','r',encoding='utf-8'))
          req = ["date","quote","quoteCitation","firstReading","secondReading",
                 "psalmSummary","gospelSummary","saintReflection","dailyPrayer",
                 "theologicalSynthesis","exegesis","usccbLink","cycle","weekdayCycle",
                 "feast","gospelReference","firstReadingRef","secondReadingRef",
                 "psalmRef","gospelRef","lectionaryKey"]
          bad = []
          for i, row in enumerate(d, 1):
              miss = [k for k in req if k not in row]
              types = [k for k in ("secondReading","secondReadingRef","feast")
                       if not isinstance(row.get(k, ""), str)]
              if miss or types:
                  bad.append({"index": i,
                              "missing": miss,
                              "bad_types": {k: type(row.get(k)).__name__ for k in types}})
          print("length:", len(d))
          if bad:
              print("Problems:", bad)
          else:
              print("No key/type problems found.")
          PY

      - name: Validate weeklyfeed.json (python, clear errors)
        env:
          EXPECT_LEN: ${{ github.event.inputs.days || '8' }}
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, sys, pathlib, os

          expect = int(os.environ.get("EXPECT_LEN","8"))
          p = pathlib.Path("public/weeklyfeed.json")
          if not p.exists():
              print("weeklyfeed.json missing"); sys.exit(1)
          data = json.loads(p.read_text(encoding="utf-8"))

          # 1) length check (matches requested days)
          if not isinstance(data, list) or len(data) != expect:
              got = len(data) if isinstance(data, list) else 'n/a'
              print(f"Expected {expect} rows, got: {type(data).__name__} len={got}")
              sys.exit(1)

          required = [
              "date","quote","quoteCitation","firstReading","secondReading",
              "psalmSummary","gospelSummary","saintReflection","dailyPrayer",
              "theologicalSynthesis","exegesis","usccbLink","cycle","weekdayCycle",
              "feast","gospelReference","firstReadingRef","secondReadingRef",
              "psalmRef","gospelRef","lectionaryKey","tags"
          ]
          type_string = {"secondReading","secondReadingRef","feast"}
          errs = []

          for i, row in enumerate(data, start=1):
              if not isinstance(row, dict):
                  errs.append({"index": i, "error": "not_object", "type": type(row).__name__})
                  continue
              missing = [k for k in required if k not in row]
              bad_types = {k:type(row.get(k)).__name__ for k in type_string if not isinstance(row.get(k, ""), str)}
              shape = []
              if not str(row.get("cycle","")).startswith("Year "): shape.append("cycle")
              if not str(row.get("weekdayCycle","")).startswith("Cycle "): shape.append("weekdayCycle")
              if missing or bad_types or shape:
                  errs.append({"index": i, "missing": missing, "bad_types": bad_types, "shape": shape})

          if errs:
              print("Validation errors:")
              for e in errs:
                  print(" -", e)
              sys.exit(1)

          print(f"weeklyfeed.json OK: {expect} rows, required keys present, types good.")
          PY

      - name: Commit and push weeklyfeed.json (safe)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/weeklyfeed.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: weeklyfeed update (auto)"
          git fetch origin main
          git -c rebase.autoStash=true pull --rebase origin main
          git push origin HEAD:main
