name: Generate Weekly Devotions (Fri–Thu)

on:
  schedule:
    # Fridays 03:05 ET ~ 08:05 UTC during standard time
    - cron: '5 8 * * 5'
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD). Blank = script default"
        required: false
        default: ""
      days:
        description: "How many days (default 8)"
        required: false
        default: "8"

concurrency:
  group: generate-weekly
  cancel-in-progress: true

jobs:
  gen-weekly:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # Secrets
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_PROJECT: ${{ secrets.OPENAI_PROJECT }}
      GH_PAT: ${{ secrets.GH_PAT }}
      
      # Configuration
      APP_TZ: "America/New_York"
      SAINT_JSON_URL: "https://dailylectio.org/saint.json" # Explicit backup source
      
      # Model Settings
      GEN_MODEL: "gpt-5-mini"
      GEN_FALLBACK: "gpt-5-mini"
      GEN_TEMP: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip' # <--- Speeds up installation on repeat runs
          
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 jsonschema openai

      - name: Syntax check generate_weekly.py
        shell: bash
        run: |
          python - <<'PY'
          import ast, pathlib
          p = pathlib.Path('scripts/generate_weekly.py')
          ast.parse(p.read_text(encoding='utf-8'))
          print("Syntax OK:", p)
          PY

      - name: Show existing weeklyfeed.json (if present)
        run: |
          if [ -f public/weeklyfeed.json ]; then
            echo "SHA: $GITHUB_SHA"
            head -n 20 public/weeklyfeed.json
          else
            echo "No existing public/weeklyfeed.json (first run?)"
          fi

      - name: USCCB precheck (no OpenAI calls)
        timeout-minutes: 2
        continue-on-error: true
        env:
          USCCB_PRECHECK: "1"
          START_DATE: ${{ github.event.inputs.start_date }}
          DAYS: ${{ github.event.inputs.days }}
        run: |
          set +e
          python scripts/generate_weekly.py || true
          echo "::warning::USCCB precheck completed. If it failed, check logs."

      - name: Generate weeklyfeed.json
        env:
          TZ: America/New_York
          START_DATE: ${{ github.event.inputs.start_date }}
          DAYS: ${{ github.event.inputs.days }}
          USCCB_STRICT: "0"
          USE_EWTN_FALLBACK: "1"
          USE_CATHOLIC_GALLERY: "1"
        run: |
          set -euo pipefail
          python scripts/generate_weekly.py

      - name: Sanity checks (psalm/second/saint)
        shell: bash
        run: |
          python - << 'PY'
          import json, re, sys
      
          try:
              d = json.load(open('public/weeklyfeed.json', 'r', encoding='utf-8'))
          except FileNotFoundError:
              print("weeklyfeed.json not found!")
              sys.exit(1)
      
          # Accept ANY scripture ref
          ref_re = re.compile(
              r'\b(?:[1-3]\s*)?[A-Za-z][A-Za-z ]*\s+\d+'
              r'(?::\d+[a-z]*?(?:-\d+)?(?:,\s*\d+[a-z]*?(?:-\d+)?)*)?',
              re.I,
          )
      
          errs = []
          for row in d:
              iso = row.get('date', '?')
      
              # --- psalmRef sanity ---
              ps = (row.get('psalmRef', '') or '').strip()
              if not ps or not ref_re.search(ps):
                  errs.append(f"{iso}: psalmRef looks wrong -> {ps!r}")
      
              # --- second reading sanity ---
              sr = (row.get('secondReadingRef', '') or '').strip()
              sr_txt = (row.get('secondReading', '') or '').strip()
      
              # If there's text but no ref, that's a mismatch
              if not sr and sr_txt:
                  errs.append(f"{iso}: secondReading present but secondReadingRef is empty")
      
              # --- saint / feast soft check ---
              if not (row.get('saintReflection', '').strip() or row.get('feast', '').strip()):
                  print(f"[warn] {iso}: saint/feast is blank – ok for simple weekdays.")
      
          if errs:
              print("Sanity check errors:")
              print("\n".join("• " + e for e in errs))
              sys.exit(1)
      
          print("Sanity checks ✅ passed.")
          PY

      - name: Validate structure (keys/types)
        env:
          EXPECT_LEN: ${{ github.event.inputs.days || '8' }}
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, sys, pathlib, os

          expect = int(os.environ.get("EXPECT_LEN","8"))
          p = pathlib.Path("public/weeklyfeed.json")
          if not p.exists():
              print("weeklyfeed.json missing"); sys.exit(1)
          data = json.loads(p.read_text(encoding="utf-8"))

          # 1) length check
          if not isinstance(data, list) or len(data) != expect:
              got = len(data) if isinstance(data, list) else 'n/a'
              print(f"Expected {expect} rows, got: {type(data).__name__} len={got}")
              sys.exit(1)

          required = [
              "date","quote","quoteCitation","firstReading","secondReading",
              "psalmSummary","gospelSummary","saintReflection","dailyPrayer",
              "theologicalSynthesis","exegesis","usccbLink","cycle","weekdayCycle",
              "feast","gospelReference","firstReadingRef","secondReadingRef",
              "psalmRef","gospelRef","lectionaryKey","tags"
          ]
          
          errs = []
          for i, row in enumerate(data, start=1):
              if not isinstance(row, dict):
                  errs.append(f"Row {i} is not an object")
                  continue
              missing = [k for k in required if k not in row]
              if missing:
                  errs.append(f"Row {i} missing keys: {missing}")

          if errs:
              print("Validation errors:\n" + "\n".join(errs))
              sys.exit(1)

          print(f"weeklyfeed.json OK: {expect} rows, structure valid.")
          PY

      - name: Commit and push weeklyfeed.json (safe)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/weeklyfeed.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: weeklyfeed update (auto)"
          git fetch origin main
          git -c rebase.autoStash=true pull --rebase origin main
          git push origin HEAD:main
