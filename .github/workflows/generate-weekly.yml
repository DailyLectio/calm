name: Generate Weekly Devotions (Fri–Thu)

on:
  # kick it off every Friday morning (adjust as you like)
  schedule:
    - cron: "15 9 * * FRI"
  workflow_dispatch: {}

concurrency:
  group: generate-weekly
  cancel-in-progress: true

jobs:
  weekly:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      APP_TZ: America/New_York
      # Let the script default START_DATE to “today in APP_TZ”
      DAYS: "7"

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai requests jsonschema

      - name: Fetch latest saint.json (non-fatal)
        run: |
          mkdir -p public
          curl -fsSL https://dailylectio.org/saint.json -o public/saint.json || echo "[]" > public/saint.json
          echo "saint.json size: $(wc -c < public/saint.json) bytes"

      - name: Generate weeklyfeed.json
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          APP_TZ: ${{ env.APP_TZ }}
          START_DATE: ${{ env.START_DATE }}
          DAYS: ${{ env.DAYS }}
        run: |
          python scripts/generate_weekly.py

      - name: Commit weeklyfeed.json
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/weeklyfeed.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Weekly devotions: $(date -u +%Y-%m-%d)"
          git push
  GEN_MODEL: gpt-5.0-mini
  GEN_FALLBACK: gpt-5.0-mini
